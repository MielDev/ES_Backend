<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SumUp Payment Widget Test</title>
  <!-- Inclure le SDK SumUp -->
  <script src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>
  <style>
    #sumup-card {
      max-width: 400px;
      margin: 20px auto;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    #custom-submit-button {
      display: block;
      margin: 10px auto;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #0070BA;
      color: #fff;
      border: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Tester SumUp Payment Widget</h2>

  <!-- Conteneur pour le widget -->
  <div id="sumup-card"></div>

  <!-- Bouton personnalisé pour payer -->
  <button id="custom-submit-button">Payer 1€</button>

  <script>
    const SUMUP_API_KEY = "sup_sk_DPxNh9xvp2qltRjBYVc4B5WcBXo1RJvLd"; // Remplace par ta clé API
    const MERCHANT_CODE = "MZQ42HAM"; // Remplace par ton code marchand

    let sumupCard; // pour stocker l'objet widget

    async function createCheckout() {
      const checkout_reference = "checkout_" + Date.now(); // unique à chaque clic
      try {
        const response = await fetch("https://api.sumup.com/v0.1/checkouts", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${SUMUP_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            checkout_reference: checkout_reference,
            amount: 1.00, // montant à payer
            currency: "EUR",
            merchant_code: MERCHANT_CODE,
            description: "Test Checkout Widget",
            return_url: "http://example.com" // URL de retour après paiement
          })
        });

        const data = await response.json();
        console.log("Checkout créé :", data);
        return data.id; // retourne l'ID du checkout pour le widget
      } catch (err) {
        console.error("Erreur création checkout :", err);
        alert("Erreur lors de la création du checkout !");
      }
    }

    document.getElementById("custom-submit-button").addEventListener("click", async () => {
      // Créer un nouveau checkout à chaque clic
      const checkoutId = await createCheckout();
      if (!checkoutId) return;

      // Monter le widget SumUp
      if (sumupCard) sumupCard.unmount(); // retirer ancien widget si existant
      sumupCard = SumUpCard.mount({
        id: "sumup-card",
        checkoutId: checkoutId,
        showSubmitButton: true, // on utilise notre bouton personnalisé
        onResponse: function(type, body) {
          console.log("Type :", type);
          console.log("Body :", body);

          if (type === "success") {
            alert("Paiement effectué avec succès !");
            sumupCard.unmount();
          } else if (type === "error") {
            alert("Erreur paiement : " + JSON.stringify(body));
          }
        }
      });

      // Soumettre le paiement via le bouton personnalisé
      sumupCard.submit();
    });
  </script>
</body>
</html>
